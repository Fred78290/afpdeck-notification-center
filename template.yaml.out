AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'afpdeck-notification-center

  Lambda for afpdeck-notification-center

  '
Globals:
  Function:
    Timeout: 15
Parameters:
  LambdaArch:
    Type: String
    Default: arm64
  ApiDomainName:
    Type: String
    Default: aldunelabs.com
  PublicApiStageName:
    Type: String
    Default: api
  PublicApiGatewayName:
    Type: String
    Default: afpdeck-notification-center
  PublicApiKey:
    Type: String
    Default: '0C0D8D6B-CEAC-42E7-AA28-A1A31129D392'
Resources:
  AfpDeckNotificationCenterApi:
    Type: AWS::Serverless::Api
    Properties:
      Name:
        Ref: PublicApiGatewayName
      Description: public rest api afpdeck notification center
      EndpointConfiguration:
        Type: REGIONAL
      OpenApiVersion: 3.0.1
      StageName:
        Ref: PublicApiStageName
      TracingEnabled: true
      BinaryMediaTypes:
      - '*~1*'
      ApiKeySourceType: HEADER
      Auth:
        ApiKeyRequired: true
        UsagePlan:
          CreateUsagePlan: PER_API
          Description: Example usage plan
          UsagePlanName:
            Ref: PublicApiGatewayName
    Metadata:
      SamResourceId: AfpDeckNotificationCenterApi
  AfpDeckNotificationCenterFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: s3://aws-sam-cli-managed-default-samclisourcebucket-19x2raou6xf27/8e0cc5375ec8e0a4c6a552407cc2c1f6
      Handler: app.lambdaHandler
      Runtime: nodejs18.x
      Architectures:
      - Ref: LambdaArch
      Events:
        Root:
          Type: Api
          Properties:
            Path: /
            Method: ANY
            RestApiId:
              Ref: AfpDeckNotificationCenterApi
        Proxy:
          Type: Api
          Properties:
            RestApiId:
              Ref: AfpDeckNotificationCenterApi
            Path: /{proxy+}
            Method: ANY
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2020
        Sourcemap: true
        EntryPoints:
        - app.ts
      SamResourceId: AfpDeckNotificationCenterFunction
  ApplicationResourceGroup:
    Type: AWS::ResourceGroups::Group
    Properties:
      Name:
        Fn::Sub: ApplicationInsights-SAM-${AWS::StackName}
      ResourceQuery:
        Type: CLOUDFORMATION_STACK_1_0
    Metadata:
      SamResourceId: ApplicationResourceGroup
  ApplicationInsightsMonitoring:
    Type: AWS::ApplicationInsights::Application
    Properties:
      ResourceGroupName:
        Ref: ApplicationResourceGroup
      AutoConfigurationEnabled: 'true'
    Metadata:
      SamResourceId: ApplicationInsightsMonitoring
  AfpDeckNotificationCenterApiUsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    DependsOn:
    - AfpDeckNotificationCenterApi
    Properties:
      UsagePlanName:
        Ref: PublicApiGatewayName
      Description: Example usage plan with a monthly quota of 1000 calls and method-level
        throttling for /pets GET
      ApiStages:
      - ApiId:
          Ref: AfpDeckNotificationCenterApi
        Stage:
          Ref: PublicApiStageName
      Quota:
        Limit: 1000
        Period: DAY
      Throttle:
        RateLimit: 100.0
        BurstLimit: 200
    Metadata:
      SamResourceId: AfpDeckNotificationCenterApiUsagePlan
  AfpDeckNotificationCenterApiApiKey:
    Type: AWS::ApiGateway::ApiKey
    Properties:
      Description: API Key
      Name:
        Fn::Sub: ${KeyName}
      Enabled: true
      Value:
        Ref: PublicApiKey
    Metadata:
      SamResourceId: AfpDeckNotificationCenterApiApiKey
  AfpDeckNotificationCenterApiUsagePlanKey:
    Type: AWS::ApiGateway::UsagePlanKey
    Properties:
      KeyId:
        Ref: AfpDeckNotificationCenterApiApiKey
      KeyType: API_KEY
      UsagePlanId:
        Ref: UsagePlan
    Metadata:
      SamResourceId: AfpDeckNotificationCenterApiUsagePlanKey
  AfpDeckNotificationCenterApiBasePathMapping:
    Type: AWS::ApiGateway::BasePathMapping
    Properties:
      BasePath:
        Ref: PublicApiStageName
      DomainName:
        Ref: ApiDomainName
      RestApiId:
        Ref: AfpDeckNotificationCenterApi
      Stage:
        Ref: AfpDeckNotificationCenterApiStage
    Metadata:
      SamResourceId: AfpDeckNotificationCenterApiBasePathMapping
Outputs:
  AfpDeckNotificationCenterApi:
    Description: API Gateway endpoint URL for Prod stage for Afpdeck Notification
      Center function
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/${AfpDeckNotificationCenterApiStage}/hello/
  AfpDeckNotificationCenterFunction:
    Description: Afpdeck Notification Center Lambda Function ARN
    Value:
      Fn::GetAtt:
      - AfpDeckNotificationCenterFunction
      - Arn
  AfpDeckNotificationCenterFunctionIamRole:
    Description: Implicit IAM Role created for Afpdeck Notification Center function
    Value:
      Fn::GetAtt:
      - AfpDeckNotificationCenterFunctionRole
      - Arn
